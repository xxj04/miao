<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    html {
      background-color: rgb(94, 13, 1);
      overflow-y: scroll;
    }

    body {
      margin: 10px;
    }

    section {
      position: relative;
      margin: auto;
    }

    img {
      position: absolute;
      outline: 1px solid white;
      outline-offset: 1px;
      margin-bottom: 10px;
      /* flex: 1; */
    }

    div {
      flex: 1;

    }

    span {
      width: 100vw;
      height: 100vh;
      margin-left: -10px;
      background-color: rgb(72, 66, 81);
      z-index: 1;
      position: fixed;
      top: 0;
      display: none;
      justify-content: center;
      align-items: center;
    }
  </style>


</head>

<body>
  <section id="huaban">
  </section>
  <span style=""></span>
  <script src="https://unpkg.com/lodash"></script>

  <script>
    var cats = [
      {
        "url": "photo-103450229.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-103450229.jpg",
        "width": 675,
        "height": 900
      },
      {
        "url": "photo-108273877.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-108273877.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "photo-115203323.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-115203323.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "photo-23583825.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-23583825.jpg",
        "width": 2048,
        "height": 1536
      },
      {
        "url": "stock-photo-123942383.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-123942383.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-124559545.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-124559545.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-132046989.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132046989.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "stock-photo-132118343.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132118343.jpg",
        "width": 2000,
        "height": 1339
      },
      {
        "url": "stock-photo-132311221.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132311221.jpg",
        "width": 1920,
        "height": 1080
      },
      {
        "url": "stock-photo-132586903.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132586903.jpg",
        "width": 2000,
        "height": 1334
      },
      {
        "url": "stock-photo-135203031.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-135203031.jpg",
        "width": 1000,
        "height": 668
      },
      {
        "url": "stock-photo-135626379.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-135626379.jpg",
        "width": 2000,
        "height": 1500
      },
      {
        "url": "stock-photo-136947953.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-136947953.jpg",
        "width": 2000,
        "height": 1348
      },
      {
        "url": "stock-photo-138378295.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-138378295.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-138436811.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-138436811.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-142950305.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-142950305.jpg",
        "width": 2000,
        "height": 1125
      },
      {
        "url": "stock-photo-143046061.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-143046061.jpg",
        "width": 843,
        "height": 1000
      },
      {
        "url": "stock-photo-143181649.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-143181649.jpg",
        "width": 2000,
        "height": 1298
      },
      {
        "url": "stock-photo-144530143.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-144530143.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-144730939.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-144730939.jpg",
        "width": 1000,
        "height": 1000
      },
      {
        "url": "stock-photo-145414771.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-145414771.jpg",
        "width": 780,
        "height": 1170
      },
      {
        "url": "stock-photo-146038669.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146038669.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-146231033.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146231033.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-146914861.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146914861.jpg",
        "width": 843,
        "height": 1000
      },
      {
        "url": "stock-photo-147877407.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-147877407.jpg",
        "width": 2000,
        "height": 1334
      },
      {
        "url": "stock-photo-147969173.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-147969173.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-148015373.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148015373.jpg",
        "width": 1170,
        "height": 781
      },
      {
        "url": "stock-photo-148704233.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148704233.jpg",
        "width": 1170,
        "height": 884
      },
      {
        "url": "stock-photo-148928293.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148928293.jpg",
        "width": 1170,
        "height": 781
      },
      {
        "url": "stock-photo-148950715.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148950715.jpg",
        "width": 1170,
        "height": 775
      },
      {
        "url": "stock-photo-21951271.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-21951271.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-21964829.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-21964829.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-22618399.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-22618399.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-31201539.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-31201539.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-34598868.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-34598868.jpg",
        "width": 542,
        "height": 768
      },
      {
        "url": "stock-photo-47252094.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-47252094.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-51980510.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-51980510.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-55601508.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-55601508.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-65681789.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-65681789.jpg",
        "width": 1840,
        "height": 1232
      },
      {
        "url": "stock-photo-70461471.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-70461471.jpg",
        "width": 1000,
        "height": 1000
      },
      {
        "url": "stock-photo-71801901.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-71801901.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-71913567.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-71913567.jpg",
        "width": 2000,
        "height": 1328
      },
      {
        "url": "stock-photo-72223295.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-72223295.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-72620185.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-72620185.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-74402039.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-74402039.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-75097491.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-75097491.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-75186237.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-75186237.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-79250373.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-79250373.jpg",
        "width": 2000,
        "height": 1325
      },
      {
        "url": "stock-photo-79692589.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-79692589.jpg",
        "width": 670,
        "height": 1000
      },
      {
        "url": "stock-photo-7979718.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-7979718.jpg",
        "width": 1024,
        "height": 680
      },
      {
        "url": "stock-photo-7980252.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-7980252.jpg",
        "width": 1024,
        "height": 680
      },
      {
        "url": "stock-photo-81390687.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-81390687.jpg",
        "width": 2000,
        "height": 1591
      },
      {
        "url": "stock-photo-81988949.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-81988949.jpg",
        "width": 667,
        "height": 1000
      },
      {
        "url": "stock-photo-83149705.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-83149705.jpg",
        "width": 775,
        "height": 1170
      }
    ]


    cats = [..._.cloneDeep(cats), ..._.cloneDeep(cats)]
    cats = [..._.cloneDeep(cats), ..._.cloneDeep(cats)]

    cats.forEach((it, idx) => {
      it.idx = idx
    })


    var section = document.getElementById('huaban')
    var width = 0
    var a = 0
    var span = document.querySelector('span')
    var 余量 = -100

    function run() {
      if (window.innerWidth == width) {
        return
      }
      else {
        width = window.innerWidth
      }


      var clo = Math.floor((window.innerWidth - 30) / 190)
      if (clo == a) {
        return
      } else {
        a = clo
      }

      cats.forEach(it => {
        it.show = false
      })
      section.innerHTML = ''
      section.style.width = clo * 190 + 'px'
      // 创建适应屏幕列
      var colHeight = Array(clo).fill(0)
      var i = 0
      for (cat of cats) {
        // 获取最矮列和行
        var mindivheight = Math.min(...colHeight)
        var idx1 = colHeight.indexOf(mindivheight)
        // 添加图片尺寸 移动位置
        cat.left = idx1 * 190
        cat.top = mindivheight
        cat.Width = 180
        cat.Height = Math.round(180 * cat.height / cat.width)
        colHeight[idx1] += cat.Height + 10
        console.log(cat, i, mindivheight)
        i++
      }
      section.style.height = Math.max(...colHeight) + 'px'


      console.log(cats)





      cats.filter(cat => {
        return cat.top + cat.Height + 10 >= window.pageYOffset - 余量
          && cat.top + 10 <= window.pageYOffset + window.innerHeight + 余量
      }).forEach(cat => {

        cat.show = true
        var img = document.createElement('img')
        img.dataset.idx = cat.idx

        img.src = cat.fullUrl
        img.style.width = cat.Width + 'px'
        img.style.height = cat.Height + 'px'
        img.style.transform = `translate(${cat.left}px, ${cat.top}px)`
        img.style.opacity = '0'

        img.onload = () => {
          img.style.opacity = '1'
        }

        console.log(img)
        section.append(img)
      })
    }
    run()

    window.onresize = run




    var prevPageYOffset = 0

    window.onscroll = (e) => {
      if (Math.abs(window.pageYOffset - prevPageYOffset) < 100) {
        return
      }
      var imgs = section.querySelectorAll('img')



      var shownCat = cats.filter(cat => cat.show == true)

      var toshow = cats.filter(cat => {
        return cat.top + cat.Height + 10 >= window.pageYOffset - 余量
          && cat.top + 10 <= window.pageYOffset + window.innerHeight + 余量
      })
      var leaveCats = _.difference(shownCat, toshow)


      // 将它们标记为不再显示
      leaveCats.forEach(it => {
        it.show = false
        var img = section.querySelector(`[data-idx="${it.idx}"]`)
        img.remove()
      })


      var newCats = _.difference(toshow, shownCat)


      newCats.forEach(cat => {
        cat.show = true

        var img = document.createElement('img')
        img.dataset.idx = cat.idx
        img.src = cat.fullUrl
        img.style.width = cat.Width + 'px'
        img.style.height = cat.Height + 'px'
        img.style.transform = `translate(${cat.left}px, ${cat.top}px)`
        img.style.opacity = '0'
        img.onload = () => {
          img.style.opacity = '1'
        }

        section.append(img)
      })


      prevPageYOffset = window.pageYOffset

    }

    function debounce(f, time) {
      var taskId

      return function (...args) {
        clearTimeout(taskId)
        taskId = setTimeout(() => {
          f.call(this, ...args)
        }, time)
      }
    }


    var zIndex = 10
    section.addEventListener('click', function (e) {
      if (e.target.nodeName == 'IMG') {
        var img = e.target

        var box = img.getBoundingClientRect()
        var zx = window.innerWidth / box.width
        var zy = window.innerHeight / box.height

        document.documentElement.style.overflowY = 'hidden'
        document.documentElement.style.overflowX = 'hidden'

        span.style.display = 'flex'
        span.append(document.createElement('img'))
        var imgs = document.querySelector('span img')
        imgs.src = img.src
        imgs.style.width = parseInt(img.width) + 'px'
        imgs.style.height = parseInt(img.height) + 'px'
        imgs.style.zIndex = zIndex++
        imgs.style.transform = `scale(${Math.min(zx, zy)})`
      }
    })

    span.addEventListener('click', function () {

      span.style.display = 'none'
      span.innerHTML = ''
      document.documentElement.style.overflowY = ''
      document.documentElement.style.paddingRight = ''
    })



  </script>
</body>

</html>